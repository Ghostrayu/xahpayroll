# WALLET INTEGRATION GUIDE

**‚ö†Ô∏è IMPORTANT UPDATE (2025-12-30)**: XAH Payroll now exclusively supports Xaman wallet for production use. GemWallet and Crossmark support has been removed to streamline the user experience and focus on the most robust wallet integration.

---

## SUPPORTED WALLETS

### XAMAN (XUMM) - PRIMARY WALLET
**STATUS**: ‚úÖ **PRODUCTION SUPPORTED** - RECOMMENDED FOR ALL USERS

- **TYPE**: MOBILE & DESKTOP APP (IOS, ANDROID, WINDOWS, MAC, LINUX)
- **CONNECTION METHOD**: QR CODE SCANNING + DEEP LINKING + PUSH NOTIFICATIONS
- **DOWNLOAD**: https://xaman.app
- **FEATURES**:
  - ‚úÖ MOST SECURE OPTION (PRIVATE KEYS NEVER LEAVE DEVICE)
  - ‚úÖ WORKS ON ANY DEVICE WITH CAMERA (QR CODE)
  - ‚úÖ DEEP LINKING FOR SEAMLESS MOBILE EXPERIENCE
  - ‚úÖ PUSH NOTIFICATIONS FOR TRANSACTION REQUESTS
  - ‚úÖ NO BROWSER EXTENSION REQUIRED
  - ‚úÖ BEST FOR MOBILE-FIRST AND DESKTOP WORKFLOWS
  - ‚úÖ ENTERPRISE-GRADE SECURITY
  - ‚úÖ OFFICIAL XRPL FOUNDATION SUPPORTED

**HOW TO CONNECT:**
1. INSTALL XAMAN APP ON YOUR DEVICE (MOBILE OR DESKTOP)
2. CREATE OR IMPORT YOUR WALLET
3. CLICK "CONNECT WALLET" ON XAH PAYROLL
4. SCAN THE QR CODE WITH YOUR XAMAN APP (MOBILE) OR APPROVE VIA DEEP LINK (DESKTOP)
5. APPROVE THE SIGN-IN REQUEST IN XAMAN
6. ‚úÖ CONNECTED - READY TO USE XAH PAYROLL

---

### MANUAL MODE - TESTING ONLY
**STATUS**: ‚ö†Ô∏è **DEVELOPMENT/TESTING ONLY** - NOT RECOMMENDED FOR PRODUCTION

- **TYPE**: DIRECT WALLET ADDRESS/SEED INPUT
- **CONNECTION METHOD**: MANUAL ENTRY
- **USE CASE**: DEVELOPMENT, TESTING, DEBUGGING
- **FEATURES**:
  - ‚ö†Ô∏è REQUIRES MANUAL SEED/ADDRESS INPUT
  - ‚ö†Ô∏è LESS SECURE THAN XAMAN (SEED EXPOSURE RISK)
  - ‚ö†Ô∏è NO QR CODE OR MOBILE APP
  - ‚ö†Ô∏è MANUAL TRANSACTION SIGNING
  - ‚ö†Ô∏è INTENDED FOR DEVELOPERS ONLY

**SECURITY WARNING**:
üö® **NEVER USE MANUAL MODE WITH REAL FUNDS OR PRODUCTION MAINNET WALLETS**
üö® **ONLY FOR TESTNET DEVELOPMENT AND DEBUGGING**

---

## WHY XAMAN-ONLY?

**Decision Rationale (2025-12-30)**:

1. **SECURITY EXCELLENCE**:
   - Xaman provides enterprise-grade key management
   - Hardware security module (HSM) support
   - Biometric authentication (Face ID, Touch ID, fingerprint)
   - No private key exposure

2. **OFFICIAL XRPL SUPPORT**:
   - Maintained by XRPL Labs (official XRPL Foundation partner)
   - Regular security audits
   - Active development and updates
   - Direct access to XRPL core team support

3. **SUPERIOR USER EXPERIENCE**:
   - QR code scanning for instant connection
   - Deep linking for seamless desktop experience
   - Push notifications for transaction requests
   - In-app transaction approval with detailed review
   - Multi-platform support (iOS, Android, Windows, Mac, Linux)

4. **REDUCED COMPLEXITY**:
   - Single wallet integration = easier maintenance
   - Consistent user experience across all platforms
   - Faster bug fixes and feature development
   - Better testing coverage

5. **PRODUCTION RELIABILITY**:
   - Proven track record with enterprise clients
   - 99.9%+ uptime SLA
   - Robust error handling
   - Comprehensive logging and debugging

---

## TECHNICAL IMPLEMENTATION

### FRONTEND INTEGRATION

THE FRONTEND USES A UNIFIED `WALLETCONTEXT` THAT HANDLES XAMAN WALLET OPERATIONS:

```typescript
// Wallet providers supported
type WalletProvider = 'xaman' | 'manual'  // Manual for testing only

// Connection flow
const { connectWallet, disconnectWallet, walletAddress, balance } = useWallet()

// Connect to Xaman wallet (Production)
await connectWallet('xaman')  // QR code + deep linking flow

// Manual mode (Testing only - DO NOT USE IN PRODUCTION)
await connectWallet('manual')  // Direct seed/address input
```

### WALLET DETECTION

THE APP AUTOMATICALLY HANDLES XAMAN WALLET AVAILABILITY:

- **XAMAN**: ALWAYS AVAILABLE (USES QR CODE, NO INSTALLATION CHECK NEEDED)
- **QR CODE FALLBACK**: WORKS ON ANY DEVICE EVEN WITHOUT XAMAN INSTALLED
- **DEEP LINKING**: AUTOMATICALLY OPENS XAMAN APP ON MOBILE DEVICES
- **PUSH NOTIFICATIONS**: SENDS TRANSACTION REQUESTS DIRECTLY TO XAMAN APP

### DEPENDENCIES

```json
{
  "xrpl": "^3.0.0",           // Core XRPL library
  "xumm-sdk": "^1.11.2"       // Xaman (XUMM) SDK for wallet integration
}
```

### XAMAN WALLET FLOWS

**SIGN-IN FLOW**:
```
User clicks "Connect Wallet"
     ‚Üì
Frontend: POST /api/xaman/create-signin
     ‚Üì
Backend: Create Xaman sign-in payload
     ‚Üì
Frontend: Display QR code + deep link
     ‚Üì
User: Scan QR or click deep link
     ‚Üì
Xaman App: User approves sign-in
     ‚Üì
Frontend: Poll /api/xaman/payload/:uuid
     ‚Üì
Backend: Verify signature from Xaman
     ‚Üì
Frontend: Extract wallet address + create session
     ‚Üì
‚úÖ AUTHENTICATED
```

**TRANSACTION SIGNING FLOW** (Payment Channel Creation/Closure):
```
User initiates transaction (Create/Close Channel)
     ‚Üì
Frontend: Prepare XRPL transaction
     ‚Üì
Frontend: POST /api/xaman/create-payload
     ‚Üì
Backend: Create Xaman payload with transaction
     ‚Üì
Frontend: Display QR code + deep link
     ‚Üì
User: Scan QR or click deep link
     ‚Üì
Xaman App: Review transaction details
     ‚Üì
Xaman App: User approves transaction
     ‚Üì
Frontend: Poll /api/xaman/payload/:uuid
     ‚Üì
Backend: Receive signed transaction
     ‚Üì
Frontend: Submit to XRPL ledger
     ‚Üì
‚úÖ TRANSACTION CONFIRMED
```

---

## USER PROFILE & AUTHENTICATION

### WALLET-BASED AUTHENTICATION

- **NO PASSWORDS REQUIRED** - AUTHENTICATION IS DONE VIA XAMAN WALLET SIGNATURES
- **WALLET ADDRESS = USER ID** - EACH WALLET ADDRESS IS UNIQUE
- **PROFILE PERSISTENCE** - USER PROFILES ARE STORED IN POSTGRESQL DATABASE
- **SIGNATURE VERIFICATION** - XAMAN PROVIDES CRYPTOGRAPHIC PROOF OF OWNERSHIP

### ACCOUNT TYPE RESTRICTIONS

‚ö†Ô∏è **IMPORTANT**: A WALLET ADDRESS CAN ONLY BE REGISTERED AS ONE ACCOUNT TYPE:

- **EMPLOYEE ACCOUNT**: FOR WORKERS WHO LOG HOURS AND RECEIVE PAYMENTS
- **NGO/EMPLOYER ACCOUNT**: FOR ORGANIZATIONS THAT MANAGE WORKERS AND FUND ESCROW

**WHY THIS RESTRICTION?**
- PREVENTS CONFLICTS IN PAYMENT FLOWS
- ENSURES CLEAR ROLE SEPARATION
- MAINTAINS AUDIT TRAIL INTEGRITY
- SIMPLIFIES DATABASE SCHEMA AND QUERIES

**SOLUTION**: USE DIFFERENT WALLET ADDRESSES FOR DIFFERENT ROLES.

---

## PROFILE SETUP FLOW

### FIRST-TIME USERS

1. **CONNECT WALLET** ‚Üí CLICK "CONNECT WITH XAMAN"
2. **SCAN QR CODE** ‚Üí USE XAMAN APP TO SCAN QR CODE (OR CLICK DEEP LINK ON MOBILE)
3. **APPROVE SIGN-IN** ‚Üí APPROVE IN XAMAN APP
4. **PROFILE CHECK** ‚Üí SYSTEM CHECKS IF PROFILE EXISTS
5. **PROFILE SETUP** ‚Üí IF NEW USER, COMPLETE PROFILE FORM:
   - DISPLAY NAME
   - ORGANIZATION NAME (FOR NGO/EMPLOYER ONLY)
   - EMAIL (OPTIONAL)
   - PHONE NUMBER (OPTIONAL)
   - ACCOUNT TYPE (EMPLOYEE OR NGO/EMPLOYER)
6. **TERMS OF SERVICE** ‚Üí ACCEPT TERMS
7. **DASHBOARD ACCESS** ‚Üí REDIRECTED TO APPROPRIATE DASHBOARD

### RETURNING USERS

1. **CONNECT WALLET** ‚Üí CLICK "CONNECT WITH XAMAN"
2. **SCAN QR CODE** ‚Üí USE XAMAN APP TO SCAN QR CODE
3. **APPROVE SIGN-IN** ‚Üí APPROVE IN XAMAN APP
4. **AUTO-LOGIN** ‚Üí SYSTEM RETRIEVES EXISTING PROFILE
5. **DASHBOARD ACCESS** ‚Üí AUTOMATICALLY REDIRECTED TO DASHBOARD

---

## SECURITY CONSIDERATIONS

### PRIVATE KEY MANAGEMENT

- **NON-CUSTODIAL**: XAH PAYROLL NEVER HAS ACCESS TO PRIVATE KEYS
- **XAMAN-CONTROLLED**: ALL PRIVATE KEYS MANAGED BY XAMAN APP
- **NO KEY STORAGE**: PRIVATE KEYS REMAIN IN XAMAN APP (NEVER ON SERVER OR BROWSER)
- **HARDWARE SECURITY**: XAMAN SUPPORTS HARDWARE WALLETS AND HSM
- **BIOMETRIC PROTECTION**: OPTIONAL FACE ID/TOUCH ID/FINGERPRINT LOCKS

### TRANSACTION SIGNING

ALL TRANSACTIONS ARE SIGNED BY XAMAN WALLET:
1. APP PREPARES XRPL TRANSACTION
2. SENDS TO XAMAN VIA XUMM SDK
3. XAMAN DISPLAYS TRANSACTION DETAILS TO USER
4. USER REVIEWS AND APPROVES IN XAMAN APP
5. XAMAN SIGNS TRANSACTION WITH PRIVATE KEY
6. SIGNED TRANSACTION RETURNED TO APP
7. APP SUBMITS TO XRPL LEDGER
8. CONFIRMATION RECEIVED FROM LEDGER

### SESSION MANAGEMENT

- **WALLET-BASED SESSIONS**: NO TRADITIONAL PASSWORDS
- **JWT TOKENS**: SHORT-LIVED TOKENS FOR API AUTHENTICATION
- **AUTO-LOGOUT**: SESSIONS EXPIRE ON WALLET DISCONNECTION
- **RE-AUTHENTICATION**: REQUIRES XAMAN SIGNATURE FOR SENSITIVE OPERATIONS
- **SESSION TIMEOUT**: 24-HOUR SESSION EXPIRATION FOR SECURITY

---

## TROUBLESHOOTING

### XAMAN CONNECTION ISSUES

**QR CODE NOT WORKING:**
- ‚úÖ ENSURE XAMAN APP IS INSTALLED ON MOBILE DEVICE
- ‚úÖ CHECK CAMERA PERMISSIONS
- ‚úÖ TRY GENERATING A NEW QR CODE (REFRESH PAGE)
- ‚úÖ ENSURE MOBILE DEVICE HAS INTERNET CONNECTION
- ‚úÖ CHECK IF XAMAN APP IS UP TO DATE

**DEEP LINK NOT OPENING XAMAN:**
- ‚úÖ ENSURE XAMAN APP IS INSTALLED
- ‚úÖ TRY MANUALLY OPENING XAMAN AND CHECKING "EVENTS" TAB
- ‚úÖ CHECK IF XAMAN IS SET AS DEFAULT HANDLER FOR XUMM:// LINKS
- ‚úÖ RESTART XAMAN APP

**"PAYLOAD EXPIRED" ERROR:**
- ‚è∞ XAMAN PAYLOADS EXPIRE AFTER 5 MINUTES
- ‚úÖ REFRESH THE PAGE AND TRY AGAIN
- ‚úÖ COMPLETE THE APPROVAL FASTER NEXT TIME

**"CONNECTION TIMEOUT" ERROR:**
- üåê CHECK YOUR INTERNET CONNECTION
- ‚úÖ ENSURE XAMAN APP HAS INTERNET ACCESS
- ‚úÖ TRY SWITCHING BETWEEN WIFI AND MOBILE DATA
- ‚úÖ CHECK FIREWALL/VPN SETTINGS

### ACCOUNT ISSUES

**"ACCOUNT NOT FOUND" ERROR:**
- ‚ÑπÔ∏è THIS IS NORMAL FOR NEW TESTNET ACCOUNTS
- ‚úÖ ACCOUNT WILL BE CREATED AFTER FIRST TRANSACTION
- ‚úÖ BALANCE WILL SHOW AS 0 UNTIL FUNDED
- ‚úÖ FOR MAINNET: ENSURE ACCOUNT HAS MINIMUM 10 XAH RESERVE

**"ACCOUNT NOT ACTIVATED" ERROR (PAYMENT CHANNEL CREATION):**
- ‚ö†Ô∏è WORKER WALLET MUST BE ACTIVATED ON LEDGER BEFORE CREATING PAYMENT CHANNEL
- ‚úÖ SEND 10-20 XAH TO WORKER WALLET TO ACTIVATE
- ‚úÖ WAIT FOR LEDGER CONFIRMATION (3-5 SECONDS)
- ‚úÖ TRY CREATING PAYMENT CHANNEL AGAIN

**"CONNECTION REJECTED":**
- üö´ USER DECLINED CONNECTION IN XAMAN APP
- ‚úÖ TRY CONNECTING AGAIN AND APPROVE THE REQUEST
- ‚úÖ CHECK XAMAN "EVENTS" TAB FOR PENDING REQUESTS

### PROFILE ISSUES

**"WALLET ALREADY REGISTERED AS [TYPE]":**
- ‚ö†Ô∏è THIS WALLET IS ALREADY USED FOR A DIFFERENT ACCOUNT TYPE
- ‚úÖ USE A DIFFERENT WALLET ADDRESS
- ‚ùå CANNOT SWITCH BETWEEN EMPLOYEE AND NGO/EMPLOYER TYPES
- üí° SOLUTION: CREATE A NEW WALLET IN XAMAN FOR THE OTHER ROLE

---

## BEST PRACTICES

### FOR USERS

1. **USE TESTNET FIRST**: TEST WITH TESTNET XAH BEFORE USING REAL FUNDS
2. **BACKUP WALLET**: ALWAYS BACKUP YOUR XAMAN WALLET SEED/RECOVERY PHRASE
3. **VERIFY TRANSACTIONS**: ALWAYS REVIEW TRANSACTION DETAILS IN XAMAN BEFORE APPROVING
4. **SEPARATE WALLETS**: USE DIFFERENT XAMAN WALLETS FOR EMPLOYEE VS NGO/EMPLOYER ROLES
5. **KEEP XAMAN UPDATED**: REGULARLY UPDATE XAMAN APP FROM OFFICIAL SOURCES
6. **ENABLE BIOMETRICS**: USE FACE ID/TOUCH ID FOR ADDED SECURITY
7. **NEVER SHARE SEED**: NEVER SHARE YOUR XAMAN SEED PHRASE WITH ANYONE

### FOR DEVELOPERS

1. **ERROR HANDLING**: ALWAYS HANDLE XAMAN CONNECTION ERRORS GRACEFULLY
2. **USER FEEDBACK**: SHOW CLEAR LOADING STATES DURING WALLET OPERATIONS
3. **NETWORK DETECTION**: DETECT AND DISPLAY CURRENT NETWORK (TESTNET/MAINNET)
4. **TRANSACTION VALIDATION**: VALIDATE TRANSACTIONS BEFORE SENDING TO XAMAN
5. **LOGOUT CLEANUP**: PROPERLY DISCONNECT WALLET ON LOGOUT
6. **PAYLOAD EXPIRATION**: HANDLE EXPIRED PAYLOADS WITH USER-FRIENDLY MESSAGES
7. **POLLING OPTIMIZATION**: USE EFFICIENT POLLING FOR PAYLOAD STATUS
8. **DEEP LINK TESTING**: TEST DEEP LINKS ON BOTH MOBILE AND DESKTOP

---

## MIGRATION FROM PREVIOUS WALLET SUPPORT

**FOR USERS WHO PREVIOUSLY USED CROSSMARK OR GEMWALLET**:

1. ‚úÖ **INSTALL XAMAN APP**: DOWNLOAD FROM https://xaman.app
2. ‚úÖ **IMPORT YOUR WALLET**: USE YOUR EXISTING WALLET SEED PHRASE TO IMPORT INTO XAMAN
3. ‚úÖ **CONNECT WITH XAMAN**: USE THE NEW XAMAN CONNECTION FLOW
4. ‚úÖ **VERIFY PROFILE**: YOUR PROFILE IS TIED TO WALLET ADDRESS, SO IT REMAINS THE SAME
5. ‚úÖ **RESUME WORK**: ALL PAYMENT CHANNELS, WORK SESSIONS, AND HISTORY ARE PRESERVED

**IMPORTANT NOTES**:
- ‚ö†Ô∏è YOUR WALLET ADDRESS STAYS THE SAME (PROFILE, CHANNELS, HISTORY INTACT)
- ‚ö†Ô∏è ONLY THE CONNECTION METHOD CHANGES (NOW XAMAN INSTEAD OF CROSSMARK/GEMWALLET)
- ‚úÖ NO DATA LOSS OR MIGRATION REQUIRED
- ‚úÖ IMPROVED SECURITY WITH XAMAN'S ENTERPRISE-GRADE FEATURES

---

## FEEDBACK & SUPPORT

**HAVE QUESTIONS OR ISSUES?**
- üìß OPEN AN ISSUE ON GITHUB
- üí¨ JOIN OUR COMMUNITY DISCORD
- üìñ READ XAMAN DOCUMENTATION: https://xumm.readme.io/

**FEATURE REQUESTS**:
- WE WELCOME FEEDBACK ON WALLET INTEGRATION
- SUGGEST IMPROVEMENTS VIA GITHUB ISSUES

---

## RESOURCES

- **XAMAN DOCUMENTATION**: https://xumm.readme.io/
- **XAMAN DOWNLOAD**: https://xaman.app
- **XRPL DOCUMENTATION**: https://xrpl.org/docs
- **XAH PAYROLL GITHUB**: https://github.com/your-org/xahpayroll
- **XAHAU NETWORK**: https://docs.xahau.network/

---

**LAST UPDATED**: 2026-01-02
**VERSION**: 2.0.0
**BREAKING CHANGE**: REMOVED CROSSMARK AND GEMWALLET SUPPORT (AS OF 2025-12-30)
